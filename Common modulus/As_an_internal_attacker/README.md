## **Common modulus**
### **As an internal attacker**
Tình huống trước, bạn chặn hai tin nhắn giống hệt nhau. Bây giờ, giả định rằng bạn là thành viên của công ty và sở hữu khóa riêng tư, khóa công khai riêng và có cùng mô-đun $n$ với những người khác.
Ta có: $ed$ ≡ $1 \pmod{φ(n)}$, suy ra $ed$ - $1$ là bội số của $φ(n)$, hay $ed$ - $1$ = $k$ * $φ(n)$.
Giả sử $φ(n)$ xấp xỉ bằng $n$: $k$ = $\frac{e*d - 1}{n}$.
Từ đó tính được $φ(n)$ = $\frac{e*d - 1}{k}$. (Nếu $φ(n)$ không phải là số nguyên thì tăng dần k đến khi $φ(n)$ nguyên vì giá trị $k$ là xấp xỉ)
Lúc này ta đã biết được $φ(n)$ và khóa công khai $e$ của nạn nhân A. Ta sẽ tính được khóa riêng tư của nạn nhân A $d_A$ ≡ $e_A^{-1} \pmod{φ(n)}$ rồi từ đó giải mã được tin nhắn.
#### Challenge:
1. Problem:
```
from Crypto.Util.number import *
from Crypto.Util.number import long_to_bytes as ltb, bytes_to_long as btl
from secret import FLAG

e=65537
your_e = getPrime(20)
msg=btl(FLAG)
p=getPrime(2048)
q=getPrime(2048)
n=p*q
assert(msg < n)
ct=pow(msg, e, n)
your_d = inverse(your_e, (p-1)*(q-1))
print(f"{your_e = }")
print(f"{your_d = }")
print(f"{n = }")
print(f"{e = }")
print(f"{ct = }")
```
2. Ý tưởng
* Ta đã sở hữu một cặp khóa ($your_e$, $your_d$) với cùng mô-đun $n$ và $e$ của nạn nhân
* Ta có thể tính được $φ(n)$ từ $your_e$, $your_d$ như đã nói ở trên, từ đó tìm được $d$ của nạn nhân và giải mã thông điệp.
3. Giải mã
```
from Crypto.Util.number import long_to_bytes as ltb, bytes_to_long as btl
3465085122620172726606536088151896695089891957619791347718614711293081179069089096711080241562161246197157386101555428494861370272376601862361907035948009956591858206364705462591267272303847542672035857072800527004059308615800494273674182486092387395531924597343613852979408433572334206929477220188001816526

your_e = 608371
your_d = 51474195553824664499541959894194407622752548220756328679797289969951625577168152484785888399943200487001270182205956423276128104563070687781304674561996012377511829314242024103007409868506598945125214361519640871483797022662719632298513249294283977793008794721556292748223688049791750005648803665061260366340667874678936486933741028916869652597893761118987388973046625864633952643321955199618518282447945016770970978646014130286282152827748329063676007265002845020702006087385551460207274607521523362195018243933936941658869491092482775955186596958622585034705390418230660344255660196250384130090686229812717660343898554444862972785357140880452090144090267319180731206117775176061979305582883032084315188159181309725483528092258516436251172076654100070127415092604280134305225731390914024804406546895962090439089820433466009925574290310959086619630469201655068055153129183591350267965330678273750420186695167272778399111039709206599388213836442472218791963795515527657819447389720079825227327390414651958830789962704663596933803776425296276508037175516532425323785472803112510680170998854689668850919368761119302014271638877802453039788767270612305453307938409376286449921334951170226283929051469325217034468577665474838345121713971
n = 811174920950028881394918836492447764793720774863612185863410363846896526460493876319691120625873457414258509053718946125758874008577642206869579229839556431708826553859208248816752258751799717830456463834530901091192049694970636068412868902639887005670523337742466607318471527588132540932173768540784458757441742147035339191616810348482966129274270828797292496229020821756073627860909757978166496205443304178162735014890668629876849102395287623385510587121280814093757289091797314529148034199002116031134450047411815856338507736444109283528890692353689436087262092322999742631658081835333310286424060932972227839427020248008322461613882602681849935399408337665912824066305269143122449631603824584531219020327704931413712794474603452070519601749640789921949763282952426529562310460843640023224539517928442712485015234681875680947742895473568700631451211773864509682469920141277142322421504932332712526030863478213365845942592220261398017410689603653035411951475112193831132033168757374316557108881813129370599582833236449164142465431355288749480593132225626344363537205693857441587752486176202948814025113944599366084366360926812487465941309862269776686025763880270552935058802629284161229703732636138327265943900461529299491271418603
e = 65537
ct = 712762736332866949574460872810289001392457651192976308954728333898119252954602453602264504738260412777535405990405442437257040579391806680834292891304498533665722649634696143387072824358371920484071493659955664755052618415163163892050603287234376411577133132167276971092089457291882128571203389494771749952979565257266634699789222126291194797024568234402810516387567915846538463120835344425223418450306791487495311974903682947345840470497291447992919786824277649524062131366056049247396468020940771702966239632365788598483484575630355207950953460880438995906605425677934573347859243843680398472190756689150146288864660980513577116165115852266428779551685433418366446298961849419104017314169132607752261280372608656180286970358133824681874018614915838772751903995759044613440727310379282461922366035865175278421167609318967129139748629682081894153743078352564814205428130991608290546935510621195884504545854043524247546858349664626565777529317383395852147099124897384044865297644606556288440690310661016782107027474026413601563408904327094639015025111465238026700647234674999257159708700166831661735723575491353005259146244394557057734669364953741274194195494046405113672493961421416119923896406844486339142928956848344233182326034148
phi = 0
k = (your_e * your_d - 1) // n
for i in range(1000000):
    if (your_e * your_d - 1) % k == 0:
        # right value of phi found
        phi = (your_e * your_d - 1) // k
        break
    k += 1

d = pow(e, -1 ,phi)
m = pow(ct, d, n)

print(ltb(m))
```
Kết quả:
![image](https://hackmd.io/_uploads/B1vI2phXR.png)

$=>$ **Giải pháp:** Sử dụng khóa riêng cho mỗi người dùng: Thay vì sử dụng chung một mô-đun $N$ cho tất cả các người dùng, hãy tạo một mô-đun $N$ riêng cho mỗi người dùng. Điều này sẽ ngăn chặn bất kỳ cuộc tấn công Common modulus nào vì mỗi khóa công khai sẽ duy nhất cho mỗi người dùng.